// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

/**
 * ========= 数据模型（表结构） =========
 */

// 匿名用户 / 未来可以绑到真实账号
model User {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  sessions  Session[]
  documents Document[]
}

// 浏览器会话（一个浏览器一个 sessionId）
// ✅ 允许匿名：userId 可为空
model Session {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  events  LogEvent[]

  @@index([createdAt])
  @@index([userId])
}

// 文档（你以后可以在这里保存 editor 的内容）
model Document {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  title   String
  content String

  userId String?
  user   User?  @relation(fields: [userId], references: [id], onDelete: SetNull)

  events LogEvent[]

  @@index([updatedAt])
  @@index([userId])
}

// 交互日志（最重要）
model LogEvent {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())

  // ✅ 必须属于某个 session（核心主线）
  sessionId      String
  session        Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  // ✅ 可选：属于某个文档（如果你未来做多文档）
  documentId     String?
  document       Document? @relation(fields: [documentId], references: [id], onDelete: SetNull)

  eventType      String
  toolName       String?
  selectionStart Int?
  selectionEnd   Int?
  docLength      Int?

  // ✅ Postgres 原生 JSON（比 String 好用太多）
  payloadJson    Json?

  @@index([sessionId, createdAt])
  @@index([eventType, createdAt])
  @@index([documentId, createdAt])
}
